# DevContainer Docker Compose Configuration
# This is SEPARATE from the main docker-compose.dev.yml
# Use this for VS Code/Cursor devcontainer development
# Use docker-compose.dev.yml for testing the full containerized app
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile

    volumes:
      # Mount the workspace
      - ..:/workspace:cached

      # DON'T mount .gitconfig - we'll configure Git in post-create.sh instead
      # This avoids "Device or resource busy" errors on Windows

      # Mount SSH keys for git operations
      - ~/.ssh:/home/node/.ssh:ro

      # Mount Docker socket for Docker-from-Docker (required for testing docker-compose.dev.yml)
      # Security: Provides full Docker host access to container (standard for DevContainers)
      # See .devcontainer/README.md "Security Model" section for details
      # macOS: Docker Desktop uses ~/.docker/run/docker.sock or /var/run/docker.sock (symlinked)
      - ${DOCKER_SOCKET_PATH:-/var/run/docker.sock}:/var/run/docker.sock

      # Named volumes for better performance
      - node_modules-cache:/workspace/node_modules
      # Mount entire .vscode-server directory to persist extensions, bin, and data
      - vscode-server:/home/node/.vscode-server
      - vscode-server-insiders:/home/node/.vscode-server-insiders

    # Forward ports for development
    ports:
      - "5173:5173"  # Vite dev server (React)
      - "3001:3001"  # Express API server
      - "4404:4404"  # Virtual Node (testing)
      - "8080:8080"  # Docker deployment testing

    # Environment variables
    environment:
      - NODE_ENV=development

    # Keep container running
    command: sleep infinity

    # Network mode for accessing host services if needed
    network_mode: bridge

    # Use node user for development
    user: node
    # Note: On macOS, docker group doesn't exist. Docker socket permissions are handled differently.
    # The docker-outside-of-docker feature in devcontainer.json handles this automatically.

volumes:
  node_modules-cache:
  vscode-server:
  vscode-server-insiders:
