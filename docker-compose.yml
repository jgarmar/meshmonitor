services:
  meshmonitor:
    image: ghcr.io/yeraze/meshmonitor:latest
    container_name: meshmonitor
    ports:
      - "8087:3001"
      - "4404:4404"
    restart: unless-stopped
    volumes:
      - meshmonitor-data:/data
      # Mount local scripts directory for Auto Responder scripts
      - ./scripts:/data/scripts
    env_file: .env      

  # Auto-upgrade watchdog sidecar
  meshmonitor-upgrader:
    image: docker:latest
    container_name: meshmonitor-upgrader
    restart: unless-stopped
    volumes:
      # Docker socket for container control
      - /var/run/docker.sock:/var/run/docker.sock
      # Shared data volume for trigger/status files (read-write)
      - meshmonitor-data:/data
      # Mount docker-compose directory for proper recreation
      - .:/compose:ro
    environment:
      - CONTAINER_NAME=meshmonitor
      - IMAGE_NAME=ghcr.io/yeraze/meshmonitor
      - TRIGGER_FILE=/data/.upgrade-trigger
      - STATUS_FILE=/data/.upgrade-status
      - CHECK_INTERVAL=5
      - COMPOSE_PROJECT_DIR=/compose
      - COMPOSE_PROJECT_NAME=meshmonitor
    command: /data/scripts/upgrade-watchdog.sh
    depends_on:
      - meshmonitor
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  meshmonitor-data:
    driver: local
